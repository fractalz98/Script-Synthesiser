<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Script Synthesiser – LM Studio UI</title>
    <style>
      :root {
        --bg: #0a0815;
        --panel: rgba(23, 17, 43, 0.78);
        --panel-strong: rgba(32, 23, 57, 0.9);
        --accent: #f472b6;
        --accent-2: #fb7185;
        --text: #fde7f4;
        --muted: #e9c8de;
        --border: #2f2149;
        --glass: rgba(255, 255, 255, 0.04);
        --shadow: 0 20px 70px rgba(0, 0, 0, 0.35);
        --bg-photo: none;
        --bg-photo-opacity: 0.18;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background-color: var(--bg);
        background-image:
          radial-gradient(circle at 15% 20%, rgba(244, 114, 182, 0.18), transparent 30%),
          radial-gradient(circle at 80% 10%, rgba(251, 113, 133, 0.14), transparent 32%),
          radial-gradient(circle at 50% 90%, rgba(219, 39, 119, 0.12), transparent 28%),
          linear-gradient(rgba(10, 8, 21, 0.4), rgba(10, 8, 21, 0.7)),
          var(--bg-photo);
        background-size: auto, auto, auto, cover, cover;
        background-repeat: no-repeat;
        background-position: center;
        color: var(--text);
        min-height: 100vh;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 32px 48px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        margin: 16px auto 10px;
        max-width: 1200px;
        background: linear-gradient(120deg, rgba(244, 114, 182, 0.16), rgba(251, 113, 133, 0.18));
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        position: sticky;
        top: 10px;
        z-index: 20;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: 0.2px;
        font-size: 16px;
      }

      .brand .tag {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid var(--border);
      }

      .top-actions {
        display: flex;
        gap: 10px;
      }

      .hero {
        padding: 28px;
        margin: 12px 0 18px;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
      }

      .hero .eyebrow {
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.2em;
        color: var(--muted);
        margin: 0 0 8px;
      }

      .hero h1 {
        margin: 0 0 8px;
        font-size: 30px;
        letter-spacing: 0.2px;
      }

      .hero .lede {
        margin: 0 0 14px;
        color: var(--muted);
        max-width: 720px;
        line-height: 1.5;
      }

      .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .hero-actions button {
        flex: 1;
        min-width: 180px;
      }

      main {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        grid-gap: 18px;
      }

      section {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01)),
          var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }

      section header {
        padding: 0;
        background: none;
        border: none;
        position: static;
        margin-bottom: 12px;
      }

      section h2 {
        margin: 0 0 6px;
        font-size: 18px;
      }

      label {
        display: block;
        margin: 12px 0 6px;
        color: var(--muted);
        font-size: 14px;
      }

      input, select, textarea, button {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b1221;
        color: var(--text);
        font-size: 14px;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
        line-height: 1.5;
      }

      button {
        cursor: pointer;
        font-weight: 600;
        transition: all 0.15s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border: none;
        color: #2b0f1f;
        box-shadow: 0 8px 20px rgba(244, 114, 182, 0.3);
      }

      button.secondary {
        background: #0b0a1a;
        border: 1px solid var(--border);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .row > * {
        flex: 1;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #0b1221;
        color: var(--muted);
        font-size: 13px;
      }

      .output {
        background: #0b1221;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        min-height: 140px;
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        background: rgba(244, 114, 182, 0.12);
        padding: 6px 10px;
        border-radius: 8px;
        color: var(--accent-2);
        margin-left: 8px;
      }

      ul.file-list {
        list-style: none;
        padding: 0;
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      ul.file-list li {
        padding: 4px 0;
      }

      .logs {
        background: #0b1221;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        height: 200px;
        overflow: auto;
        font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
        font-size: 13px;
        line-height: 1.4;
        color: var(--muted);
      }

      .log-entry {
        margin-bottom: 8px;
      }

      .log-entry .label {
        display: inline-block;
        min-width: 60px;
        font-weight: 600;
      }

      .log-entry.ok .label {
        color: var(--accent);
      }

      .log-entry.error .label {
        color: #f87171;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .actions button {
        flex: 1;
      }

      .controls-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .controls-row button {
        flex: 1;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin: 0 0 18px;
      }

      .stat-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow);
      }

      .stat-label {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 22px;
        font-weight: 800;
      }

      .stat-sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }

      @media (max-width: 720px) {
        main {
          grid-template-columns: 1fr;
          padding: 18px;
        }

        .row {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        Script Synthesiser
        <span class="tag">LM Studio UI</span>
      </div>
      <div class="top-actions">
        <button class="secondary" id="top-refresh">Refresh models</button>
        <button class="secondary" id="top-clear">Clear outputs</button>
      </div>
    </header>

    <div class="page">
      <section class="hero">
        <p class="eyebrow">LM Studio Companion</p>
        <h1>Blend styles, refine outputs, and script hypnotic experiences.</h1>
        <p class="lede">
          Load your local LM Studio models, upload writing samples to synthesise a master style, and generate tailored scripts with clear controls to review, export, or reset your workspace.
        </p>
        <div class="hero-actions">
          <button class="primary" id="hero-generate">Generate script</button>
          <button class="secondary" id="hero-style">Analyse style</button>
        </div>
      </section>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Loaded models</div>
          <div class="stat-value" id="stat-models">—</div>
          <div class="stat-sub" id="stat-models-sub">Pending refresh</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Uploads</div>
          <div class="stat-value" id="stat-uploads">0</div>
          <div class="stat-sub">TXT samples ready</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Log entries</div>
          <div class="stat-value" id="stat-logs">0</div>
          <div class="stat-sub">Activity & errors</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Workspace</div>
          <div class="stat-value" id="stat-workspace">Fresh</div>
          <div class="stat-sub">Outputs & style state</div>
        </div>
      </div>

      <section>
        <header>
          <h2>Workspace Controls</h2>
          <p class="subhead">Change the background, toggle live streaming, and manage persistence.</p>
        </header>
        <label for="bg-input">Background image URL (optional)</label>
        <div class="controls-row">
          <input id="bg-input" type="url" placeholder="https://example.com/image.jpg" />
          <button class="secondary" id="apply-bg">Apply</button>
          <button class="secondary" id="clear-bg">Clear</button>
        </div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="live-style" checked /> Live style stream</label>
          <label class="pill"><input type="checkbox" id="live-script" checked /> Live script stream</label>
          <label class="pill"><input type="checkbox" id="persist-state" checked /> Persistent workspace</label>
        </div>
      </section>

      <main>
      <section>
        <header>
          <h2>LM Studio Connection</h2>
          <p class="subhead">Select a loaded model and explore general chat or completions.</p>
        </header>
        <label for="model">Loaded model</label>
        <div class="row">
          <select id="model"></select>
          <button class="secondary" id="refresh-models">Refresh</button>
        </div>
        <label for="system-prompt">System prompt</label>
        <textarea id="system-prompt" placeholder="You are a helpful assistant."></textarea>
        <label for="user-prompt">User prompt</label>
        <textarea id="user-prompt" placeholder="Ask anything or request completions..."></textarea>
        <div class="row">
          <div class="pill">Temperature <input type="number" id="temperature" min="0" max="1" step="0.1" value="0.7" /></div>
          <div class="pill">Max tokens <input type="number" id="max-tokens" min="16" max="4096" step="16" value="512" /></div>
        </div>
        <button class="primary" id="send-chat">Send to LM Studio</button>
        <label>Response</label>
        <div class="output" id="chat-output"></div>
      </section>

      <section>
        <header>
          <h2>Style Synthesiser <span class="badge">TXT uploads</span></h2>
          <p class="subhead">Upload sample .txt files to extract a reusable master style.</p>
        </header>
        <label for="file-input">Sample files</label>
        <input id="file-input" type="file" accept=".txt" multiple />
        <ul class="file-list" id="file-list"></ul>
        <div class="controls-row">
          <button class="secondary" id="clear-files">Remove uploads</button>
          <button class="primary" id="analyze">Analyse Style</button>
        </div>
        <label>Master style</label>
        <div class="output" id="style-output"></div>
      </section>

      <section>
        <header>
          <h2>Hypnotic Script Generator</h2>
          <p class="subhead">Use the synthesised style to craft scripts with precise length and intensity.</p>
        </header>
        <label for="theme">Theme or focus (optional)</label>
        <input id="theme" type="text" placeholder="Calm confidence, restful sleep, motivation..." />
        <div class="row">
          <div>
            <label for="length">Approximate length (words)</label>
            <input id="length" type="number" min="100" max="3000" step="50" value="400" />
          </div>
          <div>
            <label for="intensity">Intensity (1-10)</label>
            <input id="intensity" type="number" min="1" max="10" step="1" value="6" />
          </div>
        </div>
        <label for="style-summary">Style summary</label>
        <textarea id="style-summary" placeholder="Paste or use the synthesised style above"></textarea>
        <button class="primary" id="generate">Generate Hypnotic Script</button>
        <label>Script output</label>
        <div class="output" id="script-output"></div>
        <div class="actions">
          <button class="secondary" id="clear-outputs">Clear outputs</button>
          <button class="secondary" id="save-outputs">Save outputs</button>
        </div>
      </section>

      <section>
        <header>
          <h2>Activity & Errors</h2>
          <p class="subhead">Recent requests, responses, and any errors.</p>
        </header>
        <div class="logs" id="log-output"></div>
        <div class="actions">
          <button class="secondary" id="download-log">Download log</button>
          <button class="secondary" id="clear-log">Clear log</button>
        </div>
      </section>
    </main>

    <script>
      const modelSelect = document.getElementById('model');
      const refreshBtn = document.getElementById('refresh-models');
      const topRefreshBtn = document.getElementById('top-refresh');
      const topClearBtn = document.getElementById('top-clear');
      const sendChatBtn = document.getElementById('send-chat');
      const chatOutput = document.getElementById('chat-output');
      const systemPrompt = document.getElementById('system-prompt');
      const userPrompt = document.getElementById('user-prompt');
      const temperature = document.getElementById('temperature');
      const maxTokens = document.getElementById('max-tokens');

      const fileInput = document.getElementById('file-input');
      const fileList = document.getElementById('file-list');
      const analyzeBtn = document.getElementById('analyze');
      const clearFilesBtn = document.getElementById('clear-files');
      const styleOutput = document.getElementById('style-output');

      const theme = document.getElementById('theme');
      const lengthInput = document.getElementById('length');
      const intensityInput = document.getElementById('intensity');
      const styleSummary = document.getElementById('style-summary');
      const generateBtn = document.getElementById('generate');
      const scriptOutput = document.getElementById('script-output');
      const logOutput = document.getElementById('log-output');
      const heroGenerateBtn = document.getElementById('hero-generate');
      const heroStyleBtn = document.getElementById('hero-style');
      const clearOutputsBtn = document.getElementById('clear-outputs');
      const saveOutputsBtn = document.getElementById('save-outputs');
      const downloadLogBtn = document.getElementById('download-log');
      const clearLogBtn = document.getElementById('clear-log');
      const bgInput = document.getElementById('bg-input');
      const applyBgBtn = document.getElementById('apply-bg');
      const clearBgBtn = document.getElementById('clear-bg');
      const liveStyleToggle = document.getElementById('live-style');
      const liveScriptToggle = document.getElementById('live-script');
      const persistToggle = document.getElementById('persist-state');
      const statModels = document.getElementById('stat-models');
      const statModelsSub = document.getElementById('stat-models-sub');
      const statUploads = document.getElementById('stat-uploads');
      const statLogs = document.getElementById('stat-logs');
      const statWorkspace = document.getElementById('stat-workspace');

      const logs = [];
      const STATE_KEY = 'script-synthesiser-state';
      let restoringState = false;

      const applyBackground = (url) => {
        document.documentElement.style.setProperty('--bg-photo', url ? `url('${url}')` : 'none');
      };

      const setLoading = (element, loading) => {
        element.disabled = loading;
        element.textContent = loading ? 'Working...' : element.dataset.defaultText;
      };

      const updateStats = () => {
        const modelCount =
          modelSelect.options.length && modelSelect.options[0].value !== 'No models detected'
            ? modelSelect.options.length
            : 0;
        statModels.textContent = modelCount || '—';
        statUploads.textContent = (fileInput.files && fileInput.files.length) || 0;
        statLogs.textContent = logs.length;
        const hasOutput =
          (styleOutput.textContent || '').trim().length + (scriptOutput.textContent || '').trim().length > 0;
        statWorkspace.textContent = hasOutput ? 'Active' : 'Fresh';
      };

      const setOutput = (element, content) => {
        element.textContent = content || 'No response yet';
        updateStats();
        if (!restoringState) saveState();
      };

      const addLog = (message, type = 'ok') => {
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = type === 'error' ? 'ERROR' : 'INFO';
        const text = document.createElement('span');
        text.textContent = ` ${message}`;
        entry.appendChild(label);
        entry.appendChild(text);
        logOutput.appendChild(entry);
        logOutput.scrollTop = logOutput.scrollHeight;
        logs.push({ type, message, timestamp: new Date().toISOString() });
        updateStats();
        if (!restoringState) saveState();
      };

      const clearLogs = () => {
        logOutput.innerHTML = '';
        logs.length = 0;
        statLogs.textContent = '0';
        saveState();
      };

      const saveState = () => {
        if (!persistToggle.checked) {
          localStorage.removeItem(STATE_KEY);
          return;
        }
        const state = {
          model: modelSelect.value,
          systemPrompt: systemPrompt.value,
          userPrompt: userPrompt.value,
          theme: theme.value,
          length: lengthInput.value,
          intensity: intensityInput.value,
          styleSummary: styleSummary.value,
          styleOutput: styleOutput.textContent,
          scriptOutput: scriptOutput.textContent,
          background: bgInput.value,
          liveStyle: liveStyleToggle.checked,
          liveScript: liveScriptToggle.checked,
          persist: persistToggle.checked,
          logs: logs.slice(-150)
        };
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      };

      const restoreState = () => {
        const raw = localStorage.getItem(STATE_KEY);
        if (!raw) return;
        try {
          restoringState = true;
          const state = JSON.parse(raw);
          persistToggle.checked = state.persist ?? true;
          liveStyleToggle.checked = state.liveStyle ?? true;
          liveScriptToggle.checked = state.liveScript ?? true;
          bgInput.value = state.background || '';
          applyBackground(state.background);
          systemPrompt.value = state.systemPrompt || '';
          userPrompt.value = state.userPrompt || '';
          theme.value = state.theme || '';
          lengthInput.value = state.length || lengthInput.value;
          intensityInput.value = state.intensity || intensityInput.value;
          styleSummary.value = state.styleSummary || '';
          setOutput(styleOutput, state.styleOutput || '');
          setOutput(scriptOutput, state.scriptOutput || '');
          (state.logs || []).forEach((entry) => addLog(entry.message, entry.type));
        } catch (error) {
          console.error('Could not restore state', error);
        } finally {
          restoringState = false;
          updateStats();
        }
      };

      const streamCompletion = async (url, payload, onText) => {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok || !response.body) {
          throw new Error(`Stream failed with status ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let aggregated = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n\n');
          buffer = parts.pop();
          for (const part of parts) {
            const lines = part.split('\n').filter((line) => line.startsWith('data:'));
            const dataStr = lines.map((line) => line.replace(/^data:\s*/, '')).join('\n').trim();
            if (!dataStr) continue;
            if (dataStr === '[DONE]') {
              return aggregated;
            }
            try {
              const json = JSON.parse(dataStr);
              const delta =
                json?.choices?.[0]?.delta?.content ||
                json?.choices?.[0]?.message?.content ||
                '';
              if (delta) {
                aggregated += delta;
                onText(aggregated);
              }
            } catch (error) {
              console.warn('Stream parse error', error);
            }
          }
        }
        return aggregated;
      };

      const listModels = async () => {
        modelSelect.innerHTML = '<option>Loading models...</option>';
        try {
          const response = await fetch('/api/models');
          const data = await response.json();
          const models = data.data || [];
          modelSelect.innerHTML = '';
          if (!models.length) {
            modelSelect.innerHTML = '<option>No models detected</option>';
            addLog('No models detected from LM Studio.', 'error');
            statModelsSub.textContent = 'No models found';
            updateStats();
            return;
          }
          models.forEach((model) => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.id;
            modelSelect.appendChild(option);
          });
          addLog(`Loaded ${models.length} model(s) from LM Studio.`);
          statModelsSub.textContent = `Updated ${new Date().toLocaleTimeString()}`;
          updateStats();
        } catch (error) {
          modelSelect.innerHTML = '<option>Could not reach LM Studio</option>';
          console.error(error);
          addLog('Could not reach LM Studio while listing models.', 'error');
          statModelsSub.textContent = 'Connection issue';
          updateStats();
        }
      };

      const sendChat = async () => {
        const model = modelSelect.value;
        if (!model) return alert('Please select a model.');
        const messages = [];
        if (systemPrompt.value.trim()) {
          messages.push({ role: 'system', content: systemPrompt.value.trim() });
        }
        messages.push({ role: 'user', content: userPrompt.value.trim() });

        sendChatBtn.dataset.defaultText = 'Send to LM Studio';
        setLoading(sendChatBtn, true);
        setOutput(chatOutput, '');
        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model,
              messages,
              temperature: Number(temperature.value) || 0.7,
              maxTokens: Number(maxTokens.value) || 512
            })
          });
          const data = await response.json();
          const content = data?.choices?.[0]?.message?.content || 'No response';
          setOutput(chatOutput, content);
          addLog(`Chat request completed with model ${model}.`);
        } catch (error) {
          setOutput(chatOutput, 'Error reaching LM Studio.');
          console.error(error);
          addLog(`Chat request failed: ${error.message || error}`, 'error');
        } finally {
          setLoading(sendChatBtn, false);
        }
      };

      const readFiles = async () => {
        const files = Array.from(fileInput.files || []);
        fileList.innerHTML = '';
        if (!files.length) return [];
        files.forEach((file) => {
          const li = document.createElement('li');
          li.textContent = `${file.name} (${Math.round(file.size / 1024)}kb)`;
          fileList.appendChild(li);
        });
        const contents = await Promise.all(files.map((file) => file.text()));
        updateStats();
        return contents;
      };

      const clearFiles = () => {
        fileInput.value = '';
        fileList.innerHTML = '';
        addLog('Removed uploaded scripts.');
        updateStats();
      };

      const clearOutputs = () => {
        setOutput(styleOutput, '');
        setOutput(scriptOutput, '');
        styleSummary.value = '';
        addLog('Cleared outputs and style summary.');
        updateStats();
      };

      const saveOutputs = () => {
        const content = [
          '--- Style Output ---',
          styleOutput.textContent || '(none)',
          '',
          '--- Script Output ---',
          scriptOutput.textContent || '(none)'
        ].join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'script-synthesiser-outputs.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addLog('Saved outputs to text file.');
      };

      const downloadLogs = () => {
        if (!logs.length) {
          addLog('No log entries to download.', 'error');
          return;
        }
        const content = logs
          .map((entry) => `[${entry.timestamp}] ${entry.type.toUpperCase()}: ${entry.message}`)
          .join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'script-synthesiser-log.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addLog('Downloaded log file.');
      };


      const analyzeStyle = async () => {
        const model = modelSelect.value;
        if (!model) return alert('Please select a model.');
        const samples = await readFiles();
        if (!samples.length) return alert('Attach at least one .txt file.');
        analyzeBtn.dataset.defaultText = 'Analyse Style';
        setLoading(analyzeBtn, true);
        setOutput(styleOutput, '');
        try {
          if (liveStyleToggle.checked) {
            const finalText = await streamCompletion(
              '/api/analyze-style/stream',
              { model, samples },
              (text) => {
                setOutput(styleOutput, text);
                styleSummary.value = text;
              }
            );
            styleSummary.value = finalText || styleSummary.value;
            addLog(`Style analysis streamed with model ${model}.`);
          } else {
            const response = await fetch('/api/analyze-style', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model, samples })
            });
            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content || 'No style returned';
            setOutput(styleOutput, content);
            styleSummary.value = content;
            addLog(`Style analysis completed with model ${model}.`);
          }
          saveState();
        } catch (error) {
          setOutput(styleOutput, 'Error synthesising style.');
          console.error(error);
          addLog(`Style analysis failed: ${error.message || error}`, 'error');
        } finally {
          setLoading(analyzeBtn, false);
        }
      };

      const generateScript = async () => {
        const model = modelSelect.value;
        const summary = styleSummary.value.trim();
        if (!model) return alert('Please select a model.');
        if (!summary) return alert('Add a style summary first.');
        generateBtn.dataset.defaultText = 'Generate Hypnotic Script';
        setLoading(generateBtn, true);
        setOutput(scriptOutput, '');
        try {
          if (liveScriptToggle.checked) {
            const final = await streamCompletion(
              '/api/generate-script/stream',
              {
                model,
                styleSummary: summary,
                length: Number(lengthInput.value) || 400,
                intensity: Number(intensityInput.value) || 6,
                theme: theme.value.trim()
              },
              (text) => setOutput(scriptOutput, text)
            );
            addLog(`Script generation streamed with model ${model}.`);
          } else {
            const response = await fetch('/api/generate-script', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                model,
                styleSummary: summary,
                length: Number(lengthInput.value) || 400,
                intensity: Number(intensityInput.value) || 6,
                theme: theme.value.trim()
              })
            });
            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content || 'No script returned';
            setOutput(scriptOutput, content);
            addLog(`Script generation completed with model ${model}.`);
          }
          saveState();
        } catch (error) {
          setOutput(scriptOutput, 'Error generating script.');
          console.error(error);
          addLog(`Script generation failed: ${error.message || error}`, 'error');
        } finally {
          setLoading(generateBtn, false);
        }
      };

      refreshBtn.dataset.defaultText = 'Refresh';
      sendChatBtn.dataset.defaultText = 'Send to LM Studio';
      analyzeBtn.dataset.defaultText = 'Analyse Style';
      generateBtn.dataset.defaultText = 'Generate Hypnotic Script';
      clearFilesBtn.dataset.defaultText = 'Remove uploads';
      clearOutputsBtn.dataset.defaultText = 'Clear outputs';
      saveOutputsBtn.dataset.defaultText = 'Save outputs';
      downloadLogBtn.dataset.defaultText = 'Download log';
      clearLogBtn.dataset.defaultText = 'Clear log';
      topRefreshBtn.dataset.defaultText = 'Refresh models';
      topClearBtn.dataset.defaultText = 'Clear outputs';
      statModelsSub.textContent = 'Pending refresh';
      heroGenerateBtn.dataset.defaultText = 'Generate script';
      heroStyleBtn.dataset.defaultText = 'Analyse style';

      refreshBtn.addEventListener('click', listModels);
      topRefreshBtn.addEventListener('click', listModels);
      sendChatBtn.addEventListener('click', sendChat);
      analyzeBtn.addEventListener('click', analyzeStyle);
      generateBtn.addEventListener('click', generateScript);
      heroGenerateBtn.addEventListener('click', generateScript);
      heroStyleBtn.addEventListener('click', analyzeStyle);
      clearFilesBtn.addEventListener('click', clearFiles);
      clearOutputsBtn.addEventListener('click', clearOutputs);
      saveOutputsBtn.addEventListener('click', saveOutputs);
      downloadLogBtn.addEventListener('click', downloadLogs);
      clearLogBtn.addEventListener('click', clearLogs);
      topClearBtn.addEventListener('click', clearOutputs);
      applyBgBtn.addEventListener('click', () => {
        applyBackground(bgInput.value);
        addLog('Applied custom background image.');
        saveState();
      });
      clearBgBtn.addEventListener('click', () => {
        bgInput.value = '';
        applyBackground('');
        addLog('Cleared background image.');
        saveState();
      });
      persistToggle.addEventListener('change', saveState);
      liveStyleToggle.addEventListener('change', saveState);
      liveScriptToggle.addEventListener('change', saveState);
      [systemPrompt, userPrompt, theme, lengthInput, intensityInput, styleSummary].forEach((el) => {
        el.addEventListener('input', () => saveState());
      });

      restoreState();
      listModels();
      if (!logs.length) clearLogs();
      updateStats();
    </script>
  </body>
</html>
